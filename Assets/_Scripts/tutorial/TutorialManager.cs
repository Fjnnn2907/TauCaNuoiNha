using UnityEngine;
using TMPro;
using UnityEngine.UI;
using System.Collections.Generic;

public class TutorialManager : MonoBehaviour
{
    [System.Serializable]
    public class TutorialStep
    {
        [TextArea] public string dialogueVN;   // üáªüá≥ Ti·∫øng Vi·ªát
        [TextArea] public string dialogueEN;   // üá¨üáß Ti·∫øng Anh

        public Button buttonToClick; // n√∫t c·∫ßn highlight
        public bool showArrow = true;
        public ArrowPosition arrowPosition = ArrowPosition.Right;
    }

    public enum ArrowPosition { Left, Right, Top, Bottom }

    [SerializeField] private GameObject tutorialPanel;
    [SerializeField] private TextMeshProUGUI dialogueText;
    [SerializeField] private List<TutorialStep> steps;

    [Header("Highlight UI")]
    [SerializeField] private RectTransform highlightImage;
    [SerializeField] private float arrowOffset = 80f;

    [Header("Tutorial Settings")]
    [SerializeField] private float endTutorialDelay = 3f; // ‚è± th·ªùi gian ch·ªù tr∆∞·ªõc khi t·∫Øt tutorial

    private int currentStep = -1;
    private Dictionary<Button, bool> originalStates = new Dictionary<Button, bool>();
    private bool isEnding = false;

    private void Start()
    {
        if (GameSettings.EnableTutorial)
        {
            originalStates.Clear();
            foreach (var b in FindObjectsOfType<Button>(true))
                originalStates[b] = b.interactable;

            tutorialPanel.SetActive(true);
            NextStep();
        }
        else
        {
            tutorialPanel.SetActive(false);
            if (highlightImage != null) highlightImage.gameObject.SetActive(false);
        }
    }

    private void NextStep()
    {
        currentStep++;

        if (currentStep >= steps.Count)
        {
            EndTutorial();
            return;
        }

        var step = steps[currentStep];

        // üî• Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã
        if (LanguageManager.Instance.currentLanguage == LanguageManager.Language.Vietnamese)
            dialogueText.text = step.dialogueVN;
        else
            dialogueText.text = step.dialogueEN;

        // Highlight + m≈©i t√™n
        if (highlightImage != null && step.buttonToClick != null && step.showArrow)
        {
            highlightImage.gameObject.SetActive(true);
            RectTransform btnRect = step.buttonToClick.GetComponent<RectTransform>();

            Canvas rootCanvas = tutorialPanel.GetComponentInParent<Canvas>();
            highlightImage.SetParent(rootCanvas.transform, false);

            Vector3 worldPos = btnRect.position;
            Vector2 localPoint;
            RectTransformUtility.ScreenPointToLocalPointInRectangle(
                rootCanvas.transform as RectTransform,
                RectTransformUtility.WorldToScreenPoint(null, worldPos),
                rootCanvas.worldCamera,
                out localPoint
            );

            Vector2 offset = Vector2.zero;
            Vector3 scale = Vector3.one;

            switch (step.arrowPosition)
            {
                case ArrowPosition.Left:
                    offset = new Vector2(-arrowOffset, 0);
                    scale = new Vector3(-1, 1, 1);
                    break;
                case ArrowPosition.Right:
                    offset = new Vector2(arrowOffset, 0);
                    scale = new Vector3(1, 1, 1);
                    break;
                case ArrowPosition.Top:
                    offset = new Vector2(0, arrowOffset);
                    break;
                case ArrowPosition.Bottom:
                    offset = new Vector2(0, -arrowOffset);
                    scale = new Vector3(1, -1, 1);
                    break;
            }

            highlightImage.localPosition = localPoint + offset;
            highlightImage.localScale = scale;
            highlightImage.SetAsLastSibling();
        }
        else if (highlightImage != null)
        {
            highlightImage.gameObject.SetActive(false);
        }

        // üîí Kh√≥a to√†n b·ªô button
        foreach (var b in originalStates.Keys)
            b.interactable = false;

        // ‚úÖ Ch·ªâ b·∫≠t n√∫t c·∫ßn b·∫•m
        if (step.buttonToClick != null)
        {
            step.buttonToClick.interactable = true;
            step.buttonToClick.onClick.AddListener(OnTutorialButtonClicked);
        }

        // üïí N·∫øu l√† b∆∞·ªõc cu·ªëi c√πng th√¨ set timer auto t·∫Øt
        if (currentStep == steps.Count - 1 && !isEnding)
        {
            isEnding = true;
            Invoke(nameof(EndTutorial), endTutorialDelay);
        }
    }

    private void OnTutorialButtonClicked()
    {
        steps[currentStep].buttonToClick.onClick.RemoveListener(OnTutorialButtonClicked);

        // N·∫øu ƒëang ·ªü b∆∞·ªõc cu·ªëi -> t·∫Øt ngay (h·ªßy timer auto)
        if (currentStep == steps.Count - 1)
        {
            CancelInvoke(nameof(EndTutorial));
            EndTutorial();
        }
        else
        {
            NextStep();
        }
    }

    private void EndTutorial()
    {
        tutorialPanel.SetActive(false);
        if (highlightImage != null) highlightImage.gameObject.SetActive(false);

        foreach (var kvp in originalStates)
        {
            if (kvp.Key != null)
                kvp.Key.interactable = kvp.Value;
        }

        GameSettings.EnableTutorial = false;
        Debug.Log("‚úÖ Tutorial finished & restored button states!");
    }
}
